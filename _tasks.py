import shutil
import subprocess
from pathlib import Path

HERE = Path(__file__).parent


def task_docs(clean=False):
    """Build the html docs using Sphinx."""
    # Delete Autogenerated files from previous run
    if clean:
        shutil.rmtree(str(HERE.joinpath("docs/modules/generated")), ignore_errors=True)
        shutil.rmtree(str(HERE.joinpath("docs/_build")), ignore_errors=True)
        shutil.rmtree(str(HERE.joinpath("docs/auto_examples")), ignore_errors=True)

    subprocess.run("sphinx-build -b html -j auto -d docs/_build docs docs/_build/html", shell=True, check=True)


def task_update_example_data(raise_if_changes=False):
    import pooch

    registry_path = HERE.joinpath("example_data/_example_data_registry.txt")

    # Hash of old registry
    with open(registry_path) as f:
        old_registry = f.read()

    # Update the registry
    pooch.make_registry(str(HERE.joinpath("example_data")), str(registry_path))

    # Hash of new registry
    with open(registry_path) as f:
        new_registry = f.read()

    if raise_if_changes and old_registry != new_registry:
        raise ValueError("The registry has changed. Please run `poe update_example_data`.")
